<!DOCTYPE html>
<html lang="ko">
<head>
    <%- include('partials/head') %>
</head>
<body>
    <%- include('partials/header') %>

    <main class="page-content">
        <h2>회원가입</h2>
        <form action="/signup" method="POST" id="signupForm">
            <div class="form-group">
                <label for="email">이메일</label>
                <div style="display: flex; gap: 10px;">
                    <input type="email" id="email" name="email" required placeholder="example@email.com">
                    <button type="button" id="btnCheckEmail">중복 확인</button>
                </div>
                <small id="emailMsg"></small>
            </div>

            <div class="form-group">
                <label for="username">이름 (닉네임)</label>
                <input type="text" id="username" name="username" required>
            </div>

            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password" required>
            </div>

            <div class="form-group">
                <label for="confirmPassword">비밀번호 확인</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>

            <div class="form-group">
              <label for="phone">휴대폰 번호</label>
              <input type="text" id="phone" name="phone" required placeholder="010-0000-0000">
            </div>

            <button type="submit" id="btnSubmit" disabled>가입하기</button>
        </form>
    </main>

    <%- include('partials/footer') %>

    <script>
        const emailInput = document.getElementById('email');
        const btnCheck = document.getElementById('btnCheckEmail');
        const emailMsg = document.getElementById('emailMsg');
        const btnSubmit = document.getElementById('btnSubmit');
        let isEmailChecked = false; // 중복 확인 통과 여부

        // 1. 이메일 중복 확인 버튼 클릭 이벤트
        btnCheck.addEventListener('click', async () => {
            const email = emailInput.value;
            if (!email) {
                alert('이메일을 입력해주세요.');
                return;
            }

            try {
                // 서버로 AJAX 요청 전송 (fetch API)
                const response = await fetch('/api/check-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                const result = await response.json();

                if (result.available) {
                    emailMsg.style.color = 'green';
                    emailMsg.textContent = result.message;
                    isEmailChecked = true;
                    btnSubmit.disabled = false; // 가입 버튼 활성화
                    emailInput.readOnly = true; // 이메일 수정 불가 처리
                    btnCheck.disabled = true;
                } else {
                    emailMsg.style.color = 'red';
                    emailMsg.textContent = result.message;
                    isEmailChecked = false;
                    btnSubmit.disabled = true;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('중복 확인 중 오류가 발생했습니다.');
            }
        });

        // 2. 폼 제출 시 최종 확인
        document.getElementById('signupForm').addEventListener('submit', (e) => {
            if (!isEmailChecked) {
                e.preventDefault(); // 제출 막기
                alert('이메일 중복 확인을 해주세요.');
            }
            // 비밀번호 일치 확인 등 추가 가능
        });
    </script>
</body>
</html>