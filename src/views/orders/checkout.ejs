<!DOCTYPE html>
<html lang="ko">
<head>
    <%- include('../partials/head') %>
    <style>
        .checkout-container { max-width: 1000px; margin: 40px auto; padding: 20px; display: flex; gap: 40px; }
        
        /* ì™¼ìª½: ë°°ì†¡ì§€ ì…ë ¥ í¼ */
        .form-section { flex: 2; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        .address-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-zipcode { background: #555; color: white; border: none; padding: 0 15px; cursor: pointer; }

        /* ì˜¤ë¥¸ìª½: ê²°ì œ ìš”ì•½ */
        .summary-section { flex: 1; background: #f9f9f9; padding: 30px; height: fit-content; border-radius: 8px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 1rem; }
        .summary-total { border-top: 2px solid #333; padding-top: 20px; margin-top: 20px; font-weight: bold; font-size: 1.2rem; color: #d63031; }
        
        .btn-order { width: 100%; padding: 15px; background: #d63031; color: white; border: none; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }
        .btn-order:hover { background: #b71c1c; }

        .checkbox-label { font-weight: normal; font-size: 0.9rem; margin-left: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <%- include('../partials/header') %>

    <main class="checkout-container">
        <div class="form-section">
            <h2>ğŸ“¦ ë°°ì†¡ì§€ ì •ë³´</h2>
            <form action="/orders" method="POST" id="orderForm">
                
                <div class="form-group">
                    <input type="checkbox" id="sameInfo" onchange="copyUserInfo()">
                    <label for="sameInfo" style="display:inline;" class="checkbox-label">ì£¼ë¬¸ì ì •ë³´ì™€ ë™ì¼</label>
                </div>

                <div class="form-group">
                    <label>ìˆ˜ë ¹ì¸ ì´ë¦„</label>
                    <input type="text" name="receiver_name" id="receiver_name" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>íœ´ëŒ€í° ë²ˆí˜¸</label>
                    <input type="text" name="receiver_phone" id="receiver_phone" class="form-control" placeholder="010-0000-0000" required>
                </div>

                <div class="form-group">
                    <label>ë°°ì†¡ ì£¼ì†Œ</label>
                    <div class="address-group">
                        <input type="text" name="zipcode" id="zipcode" class="form-control" placeholder="ìš°í¸ë²ˆí˜¸" readonly required style="flex:1;">
                        <button type="button" class="btn-zipcode" onclick="execDaumPostcode()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
                    </div>
                    <input type="text" name="address" id="address" class="form-control" placeholder="ê¸°ë³¸ ì£¼ì†Œ" readonly required style="margin-bottom: 10px;">
                    <input type="text" name="detail_address" id="detail_address" class="form-control" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                </div>

                <div class="form-group">
                    <label>ê²°ì œ ìˆ˜ë‹¨</label>
                    <select name="payment_method" class="form-control" disabled>
                        <option value="bank" selected>ë¬´í†µì¥ ì…ê¸ˆ (ê°€ìƒ)</option>
                    </select>
                </div>
                
                </form>
        </div>

        <div class="summary-section">
            <h3>ì£¼ë¬¸ ìš”ì•½</h3>
            <div class="summary-row">
                <span>ì´ ìƒí’ˆ ê¸ˆì•¡</span>
                <span>â‚© <%= totalProductPrice.toLocaleString() %></span>
            </div>
            <div class="summary-row">
                <span>ë°°ì†¡ë¹„</span>
                <span><% if(deliveryFee === 0) { %>ë¬´ë£Œ<% } else { %>+ â‚© 3,000<% } %></span>
            </div>
            <div class="summary-row summary-total">
                <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                <span>â‚© <%= finalPrice.toLocaleString() %></span>
            </div>
            
            <button type="submit" form="orderForm" class="btn-order">ê²°ì œí•˜ê¸°</button>
        </div>
    </main>

    <%- include('../partials/footer') %>

    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        // 1. ìš°í¸ë²ˆí˜¸ ì°¾ê¸° íŒì—… ë„ìš°ê¸°
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    // íŒì—…ì—ì„œ ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ë•Œ ì‹¤í–‰í•  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë¶€ë¶„.
                    
                    var addr = ''; // ì£¼ì†Œ ë³€ìˆ˜

                    // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
                    if (data.userSelectedType === 'R') { // ë„ë¡œëª… ì£¼ì†Œ
                        addr = data.roadAddress;
                    } else { // ì§€ë²ˆ ì£¼ì†Œ
                        addr = data.jibunAddress;
                    }

                    // ìš°í¸ë²ˆí˜¸ì™€ ì£¼ì†Œ ì •ë³´ë¥¼ í•´ë‹¹ í•„ë“œì— ë„£ëŠ”ë‹¤.
                    document.getElementById('zipcode').value = data.zonecode;
                    document.getElementById("address").value = addr;
                    
                    // ì»¤ì„œë¥¼ ìƒì„¸ì£¼ì†Œ í•„ë“œë¡œ ì´ë™í•œë‹¤.
                    document.getElementById("detail_address").focus();
                }
            }).open();
        }

        // 2. ì£¼ë¬¸ì ì •ë³´ì™€ ë™ì¼ ì²´í¬ ì‹œ ìë™ ì…ë ¥
        function copyUserInfo() {
            const checkbox = document.getElementById('sameInfo');
            const user = <%- JSON.stringify(user || {}) %>; // ì„œë²„ì—ì„œ ë°›ì€ user ê°ì²´

            if (checkbox.checked) {
                document.getElementById('receiver_name').value = user.name || '';
                document.getElementById('receiver_phone').value = user.phone || '';
                document.getElementById('zipcode').value = user.zipcode || '';
                document.getElementById('address').value = user.address || '';
                document.getElementById('detail_address').value = user.detail_address || '';
            } else {
                // ì²´í¬ í•´ì œ ì‹œ ì´ˆê¸°í™”
                document.getElementById('receiver_name').value = '';
                document.getElementById('receiver_phone').value = '';
                document.getElementById('zipcode').value = '';
                document.getElementById('address').value = '';
                document.getElementById('detail_address').value = '';
            }
        }
    </script>
</body>
</html>